const express = require('express');
const http = require('http');
const { Server } = require("socket.io");
const cors = require('cors');

const app = express();
app.use(cors());

// Простой ответ для проверки работы
app.get('/', (req, res) => res.send('ForestFight Server OK'));

const server = http.createServer(app);
const io = new Server(server, {
    cors: { origin: "*", methods: ["GET", "POST"] },
    pingTimeout: 60000, // Увеличиваем таймаут, чтобы не отключало при лагах
});

let matchmakingQueue = [];

io.on('connection', (socket) => {
    console.log(`[CONNECT] ${socket.id}`);

    // Автоматическая инициализация userData, чтобы не было ошибок
    socket.userData = { username: "Unknown", rating: 1000 };

    socket.on('login', (username) => {
        socket.userData.username = username || "Player";
        console.log(`[LOGIN] ${socket.id} -> ${socket.userData.username}`);
        socket.emit('loginSuccess', socket.userData);
    });

    socket.on('findMatch', () => {
        // Проверка: если уже в очереди, не добавляем
        if (matchmakingQueue.find(s => s.id === socket.id)) return;

        matchmakingQueue.push(socket);
        console.log(`[QUEUE] Добавлен ${socket.userData.username}. Всего: ${matchmakingQueue.length}`);

        // Пытаемся создать матч
        tryMatchmaking();
    });

    socket.on('shoot', (data) => {
        socket.to(data.room).emit('enemyShoot', data);
    });

    socket.on('disconnect', () => {
        console.log(`[DISCONNECT] ${socket.id}`);
        matchmakingQueue = matchmakingQueue.filter(s => s.id !== socket.id);
    });
});

function tryMatchmaking() {
    if (matchmakingQueue.length >= 2) {
        const p1 = matchmakingQueue.shift();
        const p2 = matchmakingQueue.shift();

        // Проверяем соединение
        if (!p1.connected || !p2.connected) {
            if (p1.connected) matchmakingQueue.unshift(p1);
            if (p2.connected) matchmakingQueue.unshift(p2);
            return;
        }

        const roomName = `room_${p1.id}_${p2.id}`;
        p1.join(roomName);
        p2.join(roomName);

        console.log(`[MATCH START] ${p1.userData.username} vs ${p2.userData.username}`);

        io.to(p1.id).emit('gameStart', { room: roomName, role: 'green', opponent: p2.userData.username });
        io.to(p2.id).emit('gameStart', { room: roomName, role: 'red', opponent: p1.userData.username });
    }
}

const PORT = process.env.PORT || 3000;
server.listen(PORT, () => console.log(`Server running on port ${PORT}`));
